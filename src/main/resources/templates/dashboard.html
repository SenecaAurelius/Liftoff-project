<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head th:replace="fragments :: head">
    <meta charset="UTF-8"/>
    <title>Child Dashboard</title>

</head>
<body th:if="${userType}">

<header th:replace="dashfragment :: header"></header>
<h1>Welcome, <span th:text="${child.firstName}"></span>!</h1>


<!-- Calendar -->
<!--  date picker -->
<label for="datePicker">Select a date:</label>
<input type="date" id="datePicker" onchange="showChores(this.value)">

<!-- chores table -->
<h2>Chores for <span id="selectedDay"></span></h2>
<table class="table table-striped" id="choresTable">
    <thead>
    <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Due Date</th>
        <th>Reward Points</th>
        <th>Complete</th>
    </tr>
    </thead>
    <tbody id="choresBody"></tbody>
</table>

<!-- Script for showing chores and marking them complete -->
<script>

   function showChores(selectedDate) {
    const date = new Date(selectedDate);
    const selectedDay = date.toLocaleDateString('en-US', { weekday: 'long' });
    document.getElementById("selectedDay").textContent = selectedDay;

    // Fetch chores for the selected date
    fetch(`/chores/${dueDate.toISOString()}`)
        .then(response => response.json())
        .then(chores => {
            const choresBody = document.getElementById("choresBody");
            choresBody.innerHTML = "";

            chores.forEach(chore => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${chore.name}</td>
                    <td>${chore.choreDescription}</td>
                    <td>${chore.dueDate}</td>
                    <td>${chore.rewardPoints}</td>
                    <td>
                        <input type="checkbox" onchange="markChoreComplete(${chore.id}, this.checked)" ${chore.completed ? 'checked' : ''} />
                    </td>
                `;
                choresBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching chores:', error));
}



    function markChoreComplete(choreId, completed) {

        fetch("/updateChoreCompletion", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ choreId, completed })
        });
    }

    //  current day
    function highlightCurrentDay() {
        const currentDate = new Date();
        const dayOfWeek = currentDate.getDay();
        const dayButtons = document.getElementsByClassName("day");
        dayButtons[dayOfWeek].classList.add("current-day");
    }


    highlightCurrentDay();


    $(function() {
        $("#datePicker").datepicker({
            dateFormat: "yy-mm-dd",
            onSelect: function(selectedDate) {
                showChores(selectedDate);
            }
        });
    });

    const currentDate = new Date().toISOString().split("T")[0];
    showChores(currentDate);
</script>



<!-- Chores and Rewards -->

<h2>Chores</h2>

<table class="table table-striped">
    <thead>
    <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Due Date</th>
        <th>Reward Points</th>
        <th>Complete</th>
    </tr>
    </thead>
    <tr th:each="chore : ${chores}">
        <td th:text="${chore.name}"></td>
        <td th:text="${chore.choreDescription}"></td>
        <td th:text="${#temporals.format(chore.dueDate, 'yyyy-MM-dd')}"></td>
        <td th:text="${chore.rewardPoints}"></td>
        <td>
            <form th:action="@{/chores/markComplete}" method="post">
                <input type="hidden" name="choreId" th:value="${chore.id}" />
                <button type="submit" class="btn btn-primary">Mark Complete</button>
            </form>
        </td>
    </tr>
</table>

<h2>Earned Rewards</h2>

<table class="table table-striped">
    <thead>
    <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Reward Points</th>
    </tr>
    </thead>
    <tr th:each="reward : ${earnedRewards}">
        <td th:text="${reward.name}"></td>
        <td th:text="${reward.description}"></td>
        <td th:text="${reward.points}"></td>
    </tr>
</table>


</body>
</html>